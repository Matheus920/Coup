<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>

    <body>
        <div id="app">
            <div class="container">
                <div class="col-lg-6 offset-lg-3">
    
                    <div v-if="ready">
                        <p v-for="user in info">
                            Jogador: {{user.username}} | Moedas: {{user.coins}}
                        </p>
                    </div>
    
                    <div v-if="!ready">
                        <h4>Entre com o Usuário</h4>
                        <form @submit.prevent="addUser">
                            <div class="form-group row">
                                <input type="text" class="form-control col-9" v-model="username"
                                    placeholder="Entre com o usuário aqui">    
                            </div>
                        <h4>Entre com o nome da Sala</h4>
                        <div class="form-group row">
                            <input type="text" class="form-control col-9" v-model="room"
                                placeholder="Entre com o nome da sala aqui">
                            <input type="submit" value="Join" class="btn btn-sm btn-info ml-1">
                        </div>
                        </form>
                        
                    </div>
                    <h2 v-else>{{username}} | Sala: {{room}}</h2>
                    <div class="card bg-info" v-if="ready">
                        <div class="card-header text-white">
                            <h4>Ações</h4>
                        </div>
                        <button type="button" class="btn btn-primary" @click.prevent="ajudaExterna">Ajuda externa</button>
                        <button type="button" class="btn btn-primary" @click.prevent="pegar2">Pegar 2</button>
                        <button type="button" class="btn btn-primary" @click.prevent="duque3">DUQUE - 3</button>
                        <button type="button" class="btn btn-primary" @click.prevent="send">CAPITAO - Roubar 2</button>
                        <button type="button" class="btn btn-primary" @click.prevent="send">ASSASSINO - Matar</button>
                        <button type="button" class="btn btn-primary" @click.prevent="send">Golpe de Estado</button>
                        <button type="button" class="btn btn-primary" @click.prevent="send">EMBAIXADOR - Olhar topo</button>

                        <ul class="list-group list-group-flush text-right">
                            <li class="list-group-item" v-for="message in messages">
                                    {{message.message}}
                                    <small>:{{message.user}}</small>
                                </span>
                            </li>
                        </ul>    
                    </div>
                    <div v-if="blockText">
                        {{blockText}}
                        <button type="button" class="btn btn-primary" @click.prevent="bloquear(true, 'pegar2')">Sim</button>
                        <button type="button" class="btn btn-primary" @click.prevent="bloquear(false, 'pegar2')">Não</button>
                    </div>
                    <div v-if="influenciaText">
                        {{influenciaText}}
                        <button type="button" class="btn btn-primary" @click.prevent="duvidar(true)">Sim</button>
                        <button type="button" class="btn btn-primary" @click.prevent="duvidar(false)">Não</button>
                    </div>
                    <div v-if="ready">
                        <span v-if="provarText">{{provarText}}</span>
                        <span v-else-if="descartarText">{{descartarText}}</span>
                        Suas cartas são:
                        <ul>
                            <div v-if="provarText">
                                <li @click.prevent="provar(cards[0])">{{cards[0]}}</li>
                                <li @click.prevent="provar(cards[1])">{{cards[1]}}</li>
                            </div>
                            <div v-else-if="descartarText">
                                <li @click.prevent="descartar(cards[0])">{{cards[0]}}</li>
                                <li @click.prevent="descartar(cards[1])">{{cards[1]}}</li>
                            </div>
                            <div v-else>
                                <li>{{cards[0]}}</li>
                                <li>{{cards[1]}}</li>
                            </div>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    
    </body>

    <script>
        var socket = io();
        let vue = new Vue({
            el: '#app',

            data: {
                newMessage: null,
                id: null,
                messages: [],
                username: null,
                room: null,
                ready: false,
                info: [],
                cards: [],
                coins: 0,
                tipo: "",
                isUnblockable: true,
                influenciaText: "",
                descartarText: "",
                blockText: '',
                provarText: ''
            },

            created(){
                socket.on('chat-message', (data) => {
                    this.messages.push({
                        message: data.message,
                        user: data.user
                    });
                });

                socket.on('chanceDeBloqueio', (data) => {
                    this.blockText = "A influência do tipo " + data.tipo + " pode efetuar o bloqueio. Gostaria de bloquear?";
                });

                socket.on('declaracaoInfluencia', (data) => {
                    if(data.id != this.id){
                        this.influenciaText = "O jogador " + data.user + " declarou ser " + data.tipo + ". Deseja duvidar?";
                        this.tipo = data.tipo
                    }
                })

                socket.on('joined', (data) => {
                    this.info = data;
                });

                socket.on('deckChanges', (data) => {
                    this.cards = data;
                });

                socket.on('updateInfo', (data) => {
                    this.info = data;
                });

                socket.on('provar', (data) => {
                    this.tipo = data.tipo;
                    if(data.id == this.id){
                        this.provarText = "Prove que é a influência declarada clicando na carta correspondente a ela."
                    }
                })

                socket.on('descartarCard', (data) => {
                    if(data.id == this.id){
                        this.descartarText = "Descarte uma das suas influências clicando na carta desejada."
                    }
                })

            },

            methods: {
                ajudaExterna() {
                    socket.emit('ajuda-externa', {
                        user: this.username,
                        coins: this.coins,
                        id: this.id
                    });
                },

                duque3(){
                    socket.emit('duque3', {
                        user: this.username,
                        coins: this.coins,
                        id: this.id
                    })
                },

                pegar2(){
                    socket.emit('pegar2', {
                        user: this.username,
                        coins: this.coins,
                        id: this.id
                    })
                },

                bloquear(status, acao){
                    socket.emit('bloquear', {
                        user: this.username,
                        id: this.id,
                        status: status,
                        acao: acao
                    })
                    this.blockText = ""
                },

                duvidar(status){
                    socket.emit('duvidar', {
                        user: this.username,
                        id: this.id,
                        status: status,
                        tipo: this.tipo
                    })
                    this.influenciaText = ""
                },

                provar(carta){
                    if(carta == this.tipo){
                        socket.emit('provaCorreta', {
                            id: this.id,
                            tipo: this.tipo,
                            user: this.username,
                            cardIndex: this.cards.indexOf(carta)
                        })
                    }else {                        
                        socket.emit('realizarDescarte', {
                            id: this.id,
                            cardIndex: this.cards.indexOf(carta),
                            user: this.username
                        })
                    }
                    this.provarText = ""
                },

                descartar(carta){
                    socket.emit('realizarDescarte', {
                        id: this.id,
                        cardIndex: this.cards.indexOf(carta),
                        user: this.username
                    })
                    this.tipo = ""
                    this.descartarText = ""
                },

                addUser() {
                    socket.emit('room', {room: this.room})
                    this.id = this.uuidv4();
                    socket.emit('joined', {
                        username: this.username,
                        coins: this.coins,
                        room: this.room,
                        id: this.id
                    });
                    this.ready = true;
                },

                uuidv4() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
            },
        });
    </script>
</html>